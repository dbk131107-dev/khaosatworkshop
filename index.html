<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Khảo Sát Workshop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Quicksand', sans-serif; background-color: #f3f4f6; }
        .table-row-animate { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 bg-white p-6 rounded-xl shadow-sm">
            <div class="flex items-center mb-4 md:mb-0">
                <div class="w-12 h-12 bg-emerald-100 rounded-lg flex items-center justify-center text-emerald-600 mr-4">
                    <i class="fas fa-database text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Dữ Liệu Khảo Sát</h1>
                    <p class="text-gray-500">Workshop "Sống Xanh - Tái Chế Sáng Tạo"</p>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="fetchData()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition font-medium">
                    <i class="fas fa-sync-alt mr-2"></i> Làm mới
                </button>
                <button onclick="exportToCSV()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg transition font-medium shadow-md shadow-emerald-200">
                    <i class="fas fa-file-excel mr-2"></i> Xuất Excel/CSV
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500">
                <div class="text-gray-500 mb-2 font-medium">Tổng phản hồi</div>
                <div class="text-3xl font-bold text-gray-800" id="totalResponses">...</div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-emerald-500">
                <div class="text-gray-500 mb-2 font-medium">Muốn tham gia dự án</div>
                <div class="text-3xl font-bold text-emerald-600" id="totalYes">...</div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-gray-400">
                <div class="text-gray-500 mb-2 font-medium">Không tham gia</div>
                <div class="text-3xl font-bold text-gray-600" id="totalNo">...</div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="p-4 font-bold text-gray-600 text-sm uppercase">Thời gian</th>
                            <th class="p-4 font-bold text-gray-600 text-sm uppercase">Họ và Tên</th>
                            <th class="p-4 font-bold text-gray-600 text-sm uppercase">MSSV</th>
                            <th class="p-4 font-bold text-gray-600 text-sm uppercase text-center">Tham gia?</th>
                            <th class="p-4 font-bold text-gray-600 text-sm uppercase w-1/3">Ý kiến đóng góp</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-gray-100">
                        <tr>
                            <td colspan="5" class="p-8 text-center text-gray-500">
                                <i class="fas fa-spinner fa-spin mr-2"></i> Đang tải dữ liệu...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let surveyData = []; // Store data for CSV export

        // Authentication
        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth error:", error);
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                fetchData();
            }
        });

        initAuth();

        // Fetch Data Function
        window.fetchData = async function() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i> Đang cập nhật...</td></tr>`;

            try {
                // Query path must match the submission form
                // Note: Indexing might be required for orderBy, so we use simple fetching then sort in JS for robustness here
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'workshop_responses'));
                const querySnapshot = await getDocs(q);

                surveyData = [];
                let yesCount = 0;
                let noCount = 0;

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // Convert Firestore timestamp to Date
                    const date = data.submittedAt ? new Date(data.submittedAt.seconds * 1000) : new Date();
                    
                    surveyData.push({
                        ...data,
                        formattedDate: date.toLocaleString('vi-VN')
                    });

                    if (data.wantsToJoin) yesCount++; else noCount++;
                });

                // Sort by date (newest first)
                surveyData.sort((a, b) => new Date(b.formattedDate) - new Date(a.formattedDate));

                // Update Stats
                document.getElementById('totalResponses').textContent = surveyData.length;
                document.getElementById('totalYes').textContent = yesCount;
                document.getElementById('totalNo').textContent = noCount;

                // Render Table
                renderTable();

            } catch (error) {
                console.error("Error fetching data:", error);
                tableBody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-red-500"><i class="fas fa-exclamation-triangle mr-2"></i> Không thể tải dữ liệu. Lỗi: ${error.message}</td></tr>`;
            }
        }

        function renderTable() {
            const tableBody = document.getElementById('tableBody');
            
            if (surveyData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-500">Chưa có dữ liệu khảo sát nào.</td></tr>`;
                return;
            }

            let html = '';
            surveyData.forEach(item => {
                const joinStatus = item.wantsToJoin 
                    ? `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800"><i class="fas fa-check mr-1"></i> Có</span>`
                    : `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">Không</span>`;

                const name = item.fullName || '<span class="text-gray-400 italic">--</span>';
                const mssv = item.studentId || '<span class="text-gray-400 italic">--</span>';

                html += `
                    <tr class="hover:bg-gray-50 transition duration-150 table-row-animate">
                        <td class="p-4 text-gray-600 text-sm whitespace-nowrap">${item.formattedDate}</td>
                        <td class="p-4 font-medium text-gray-800">${name}</td>
                        <td class="p-4 text-gray-600 font-mono text-sm">${mssv}</td>
                        <td class="p-4 text-center">${joinStatus}</td>
                        <td class="p-4 text-gray-600 text-sm italic">"${item.opinion}"</td>
                    </tr>
                `;
            });

            tableBody.innerHTML = html;
        }

        // Export to CSV Function
        window.exportToCSV = function() {
            if (surveyData.length === 0) {
                alert("Chưa có dữ liệu để xuất!");
                return;
            }

            // Add BOM for Excel to recognize UTF-8
            let csvContent = "\uFEFF"; 
            
            // Header
            csvContent += "Thời gian,Họ và Tên,MSSV,Muốn tham gia?,Ý kiến đóng góp\n";

            // Rows
            surveyData.forEach(row => {
                // Escape quotes in CSV
                const cleanOpinion = row.opinion ? row.opinion.replace(/"/g, '""') : "";
                const cleanName = row.fullName || "";
                const cleanId = row.studentId || "";
                const joinText = row.wantsToJoin ? "Có" : "Không";
                
                csvContent += `"${row.formattedDate}","${cleanName}","${cleanId}","${joinText}","${cleanOpinion}"\n`;
            });

            // Create download link
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            link.setAttribute("href", url);
            link.setAttribute("download", "khao_sat_workshop_data.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
